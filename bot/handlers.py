import logging

import telegram
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler

from bot.utils import database, format_groups_with_users
from constants import State, CallbackData

logger = logging.getLogger(__name__)


async def start_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Handles the /start command. Initializes the bot, creates database tables,
    and inserts the user into the database. Displays a menu with options.
    """

    user = update.effective_user
    logger.info(f"User {user.id} - {user.name} started the bot.")
    database.create_tables()
    database.insert_user(user.id, user.name)

    keyboard = [
        [InlineKeyboardButton("ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ğ¼Ğ¸", callback_data=str(CallbackData.MANAGE_GROUPS.value))],
        [InlineKeyboardButton("âš™ï¸ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¢Ğ¾ĞºĞµĞ½", callback_data=str(CallbackData.UPDATE_TOKEN.value))],
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.message:
        await update.message.reply_text("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:", reply_markup=reply_markup)
    else:
        await update.callback_query.edit_message_text("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:", reply_markup=reply_markup)

    return State.START.value


async def manage_groups(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Handles the "Manage Groups" callback. Displays the user's groups and provides options to create or delete groups.
    """

    user = update.effective_user
    logger.info(f"User {user.id} in \"manage_groups\"")
    query = update.callback_query
    await query.answer()

    keyboard = [
        [InlineKeyboardButton("ğŸ›  Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ", callback_data=str(CallbackData.CREATE_GROUP.value))],
        [InlineKeyboardButton("ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ", callback_data=str(CallbackData.DELETE_GROUP.value))],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data=str(CallbackData.MENU.value))],
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        f"Ğ’Ğ°ÑˆĞ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:\n{format_groups_with_users(user.id)}",
        reply_markup=reply_markup)
    return State.START.value


async def create_group_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Handles the "Create Group" callback. Checks if the user has reached the group limit
    and prompts the user to enter a group name.
    """

    user = update.effective_user
    logger.info(f"User {user.id} in \"create_group_handler\"")
    query = update.callback_query
    await query.answer()

    if len(database.get_user_groups(user.id)) >= 5:
        keyboard = [
            [InlineKeyboardButton("ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ", callback_data=str(CallbackData.DELETE_GROUP.value))],
            [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data=str(CallbackData.MENU.value))],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text("â—ï¸ Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿, Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµĞ»ÑŒĞ·Ñ",
                                      reply_markup=reply_markup)
        return State.START.value

    await query.edit_message_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹\n\nĞ˜Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚ÑŒ /start Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹")
    return State.CREATE_GROUP.value


async def receive_name_of_group(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Receives the group name from the user and creates the group in the database.
    """

    user = update.effective_user
    logger.info(f"User {user.id} in \"receive_name_of_group\"")
    user_message = update.message.text

    if database.create_group(user_message, user.id):
        keyboard = [
            [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data=str(CallbackData.MENU.value))],
        ]

        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(f"âœ… Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° \"{user_message}\" ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°", reply_markup=reply_markup)

        return State.START.value

    await update.message.reply_text("Ğ§Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº :(")
    return ConversationHandler.END


async def delete_group_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Handles the "Delete Group" callback. Displays a list of the user's groups for deletion.
    """

    user = update.effective_user
    logger.info(f"User {user.id} in \"delete_group_handler\"")
    query = update.callback_query
    await query.answer()

    groups = database.get_user_groups(user.id)

    keyboard = []
    for group in groups:
        keyboard.append([InlineKeyboardButton(f"{group.name}", callback_data=f"delete_{group.id}")])

    keyboard.append([InlineKeyboardButton(f"ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data=str(CallbackData.MANAGE_GROUPS.value))])
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€ÑƒÑ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", reply_markup=reply_markup)
    return State.DELETE_GROUP.value


async def confirm_group_deletion(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
     Confirms the deletion of a group. Displays a confirmation message with options to proceed or cancel.
    """

    logger.info(f"User {update.effective_user.id} in \"confirm_group_deletion\"")
    query = update.callback_query
    await query.answer()

    callback_data = query.data
    group_id = int(callback_data.split("_")[1])

    keyboard = [
        [InlineKeyboardButton("ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ", callback_data=f"exactly_{group_id}")],
        [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data=str(CallbackData.MENU.value))],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(f"â“ Ğ’Ñ‹ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ {database.get_group_name(group_id)}?",
                                  reply_markup=reply_markup)
    return State.DELETE_GROUP.value


async def delete_group_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Handles the actual deletion of a group from the database.
    """

    logger.info(f"User {update.effective_user.id} in \"delete_group_callback_handler\"")
    query = update.callback_query
    await query.answer()

    callback_data = query.data
    group_id = int(callback_data.split("_")[1])

    if database.delete_group(group_id):
        keyboard = [
            [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data=str(CallbackData.MENU.value))],
        ]

        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text("âœ… Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°", reply_markup=reply_markup)

        return State.START.value

    await update.message.reply_text("Ğ§Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº :(")
    return ConversationHandler.END


async def token_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Handles the "Update Token" callback. Prompts the user to enter a new token.
    """

    logger.info(f"User {update.effective_user.id} in \"token_handler\"")
    query = update.callback_query
    await query.answer()

    await query.edit_message_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Ñ‚Ğ¾ĞºĞµĞ½\n\nĞ˜Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚ÑŒ /start Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹")
    return State.ENTER_TOKEN.value


async def receive_token(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Receives the token from the user and updates it in the database.
    """

    user = update.effective_user
    logger.info(f"User {user.id} in \"token_handler\"")

    user_message = update.message.text

    if database.update_user_token(user.id, user_message):
        keyboard = [
            [InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data=str(CallbackData.MENU.value))],
        ]

        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text("âœ… Ğ¢Ğ¾ĞºĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½", reply_markup=reply_markup)

        return State.START.value

    await update.message.reply_text("Ğ§Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº :(")
    return ConversationHandler.END


async def account_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Handles the /account command. Displays the user's account information,
    including token status and sharing statistics.
    """

    user = update.effective_user
    logger.info(f"User {user.id} in \"token_handler\"")

    result = database.get_user_statistic(user.id)

    token = 'âœ”ï¸' if result.get('token') else 'âŒ'
    await update.message.reply_text(
        text=f"<b>Ğ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚\n\nĞ¢Ğ¾ĞºĞµĞ½:</b> {token}\n\nğŸ“Š <b>Statistics\n\nĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾:</b> {result.get('count_of_sharing')}\n",
        parse_mode=telegram.constants.ParseMode.HTML)


async def help_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Handles the /help command. Provides a simple response indicating no help is available.
    """

    logger.info(f"User {update.effective_user.id} in \"token_handler\"")
    await update.message.reply_text("ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ¸ Ğ½ĞµÑ‚.")
